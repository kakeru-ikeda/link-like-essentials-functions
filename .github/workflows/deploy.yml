name: Deploy to Firebase Functions

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy Functions
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: functions/package-lock.json

      - name: Install dependencies
        working-directory: ./functions
        run: npm ci

      - name: Build
        working-directory: ./functions
        run: npm run build

      - name: Create .env file
        working-directory: ./functions
        run: |
          echo "SENTRY_DSN=${{ secrets.SENTRY_DSN }}" > .env
          echo "DISCORD_REPORT_WEBHOOK_URL=${{ secrets.DISCORD_REPORT_WEBHOOK_URL }}" >> .env

      - name: Deploy to Firebase
        uses: w9jds/firebase-action@master
        with:
          args: deploy --only functions --force
        env:
          GCP_SA_KEY: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}

      - name: Notify Discord - Success
        if: success()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -H "Content-Type: application/json" \
               -d '{
                 "embeds": [{
                   "title": "✅ Firebase Functions デプロイ成功",
                   "color": 3066993,
                   "fields": [
                     {"name": "リポジトリ", "value": "'"$GITHUB_REPOSITORY"'", "inline": true},
                     {"name": "ブランチ", "value": "'"${GITHUB_REF#refs/heads/}"'", "inline": true},
                     {"name": "実行者", "value": "'"$GITHUB_ACTOR"'", "inline": true},
                     {"name": "コミット", "value": "'"$(git log -1 --pretty=%B | head -n 1)"'", "inline": false}
                   ],
                   "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"'"
                 }]
               }' \
               $DISCORD_WEBHOOK

      - name: Notify Discord - Failure
        if: failure()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -H "Content-Type: application/json" \
               -d '{
                 "embeds": [{
                   "title": "❌ Firebase Functions デプロイ失敗",
                   "color": 15158332,
                   "fields": [
                     {"name": "リポジトリ", "value": "'"$GITHUB_REPOSITORY"'", "inline": true},
                     {"name": "ブランチ", "value": "'"${GITHUB_REF#refs/heads/}"'", "inline": true},
                     {"name": "実行者", "value": "'"$GITHUB_ACTOR"'", "inline": true},
                     {"name": "ワークフロー", "value": "[実行ログを確認]('"$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"')", "inline": false}
                   ],
                   "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"'"
                 }]
               }' \
               $DISCORD_WEBHOOK

  deploy-firestore-indexes:
    name: Deploy Firestore Indexes
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect firestore.indexes.json changes
        id: detect-index-changes
        run: |
          set -euo pipefail
          if git diff --name-only HEAD^ HEAD -- firestore.indexes.json | grep -q 'firestore.indexes.json'; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Deploy Firestore indexes
        if: steps.detect-index-changes.outputs.changed == 'true'
        uses: w9jds/firebase-action@master
        with:
          args: deploy --only firestore:indexes --force
        env:
          GCP_SA_KEY: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}

      - name: Notify Discord - Index Success
        if: steps.detect-index-changes.outputs.changed == 'true' && success()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -H "Content-Type: application/json" \
               -d '{
                 "embeds": [{
                   "title": "✅ Firestore Indexes デプロイ成功",
                   "color": 3066993,
                   "fields": [
                     {"name": "リポジトリ", "value": "'"$GITHUB_REPOSITORY"'", "inline": true},
                     {"name": "タグ", "value": "'"${GITHUB_REF#refs/tags/}"'", "inline": true},
                     {"name": "実行者", "value": "'"$GITHUB_ACTOR"'", "inline": true},
                     {"name": "コミット", "value": "'"$(git log -1 --pretty=%B | head -n 1)"'", "inline": false}
                   ],
                   "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"'"
                 }]
               }' \
               $DISCORD_WEBHOOK

      - name: Skip deploy (no index changes)
        if: steps.detect-index-changes.outputs.changed != 'true'
        run: echo "firestore.indexes.json に変更がないため、デプロイをスキップします。"

      - name: Notify Discord - Index Failure
        if: steps.detect-index-changes.outputs.changed == 'true' && failure()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -H "Content-Type: application/json" \
               -d '{
                 "embeds": [{
                   "title": "❌ Firestore Indexes デプロイ失敗",
                   "color": 15158332,
                   "fields": [
                     {"name": "リポジトリ", "value": "'"$GITHUB_REPOSITORY"'", "inline": true},
                     {"name": "タグ", "value": "'"${GITHUB_REF#refs/tags/}"'", "inline": true},
                     {"name": "実行者", "value": "'"$GITHUB_ACTOR"'", "inline": true},
                     {"name": "ワークフロー", "value": "[実行ログを確認]("'"$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"'" )", "inline": false}
                   ],
                   "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"'"
                 }]
               }' \
               $DISCORD_WEBHOOK
